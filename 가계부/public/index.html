<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸ë˜ì§€ì¶œ ëŒ€ë¹„ ì¬ë¬´ ì‹œë®¬ë ˆì´í„°</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f4f7ff;
      --surface: #ffffff;
      --line: #e4eaf6;
      --text: #172033;
      --sub: #65738c;
      --primary: #2f6bff;
      --good: #09a66d;
      --warn: #f59e0b;
      --bad: #ef4f5f;
      --shadow: 0 10px 26px rgba(36, 59, 104, 0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Pretendard", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top right, #e8eeff, var(--bg) 38%);
    }
    .hidden { display: none !important; }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 24px 16px 40px; }
    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .muted { color: var(--sub); font-size: 13px; }

    #login-screen { min-height: 100vh; display: grid; place-items: center; padding: 20px; }
    .login-box { width: min(580px, 100%); padding: 42px 28px; text-align: center; }
    .login-box h1 { margin: 0 0 10px; font-size: 33px; }
    .btn-primary {
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      padding: 11px 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      min-height: 42px;
      white-space: nowrap;
    }
    .btn-ghost {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }

    .top { display: flex; justify-content: space-between; gap: 8px; align-items: center; margin-bottom: 14px; }
    .title-row { display: flex; align-items: center; gap: 8px; }
    .title-row h1 { margin: 0; font-size: 29px; }

    .kpis { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 12px; }
    .kpi { padding: 14px; }
    .kpi p { margin: 0; color: var(--sub); font-size: 13px; }
    .kpi h3 { margin: 7px 0 0; font-size: 23px; }

    .actions { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 12px; }
    .actions button {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 14px;
      text-align: left;
      font-weight: 700;
      cursor: pointer;
    }

    .layout { display: grid; grid-template-columns: 1.3fr 1fr; gap: 12px; align-items: start; }
    .section { padding: 16px; }
    .section h2 { margin: 0 0 10px; font-size: 19px; }
    .sub-head { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
    .input-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    input, select { min-height: 42px; border: 1px solid var(--line); border-radius: 10px; padding: 10px; font-family: inherit; font-size: 14px; background: #fff; flex: 1; min-width: 120px; }

    .pill { display: inline-block; border-radius: 999px; padding: 5px 11px; font-size: 12px; font-weight: 700; }
    .ok { background: rgba(9,166,109,.12); color: #0a8058; }
    .warn { background: rgba(245,158,11,.16); color: #9f6406; }
    .bad { background: rgba(239,79,95,.13); color: #ae1f35; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--line); padding: 9px 6px; text-align: left; }
    th { color: var(--sub); font-weight: 700; }
    .td-right { text-align: right; }
    .table-scroll { max-height: 290px; overflow: auto; }

    .sim-list { max-height: 312px; overflow: auto; padding-right: 4px; }
    .sim-card { background: #f8faff; border: 1px solid var(--line); border-radius: 11px; padding: 11px; margin-bottom: 8px; }
    .sim-top { display: flex; justify-content: space-between; gap: 8px; align-items: flex-start; }

    .modal-overlay { display: none; position: fixed; inset: 0; z-index: 99; background: rgba(8, 16, 34, 0.66); padding: 16px; justify-content: center; align-items: center; }
    .modal { width: min(900px, 100%); max-height: 88vh; overflow: auto; padding: 18px; border-radius: 16px; background: #fff; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .modal-head h3 { margin: 0; }
    .btn-close { border: none; background: transparent; font-size: 24px; cursor: pointer; }
    .btn-mini { border: none; border-radius: 8px; font-size: 11px; color: #fff; padding: 4px 8px; cursor: pointer; }
    .btn-edit { background: #3b82f6; }
    .btn-del { background: #ef4f5f; }

    @media (max-width: 980px) {
      .actions, .layout { grid-template-columns: 1fr; }
      .top { align-items: flex-start; }
    }
  </style>
</head>
<body>
  <section id="login-screen">
    <div class="login-box card">
      <h1>ğŸ“ˆ ë¯¸ë˜ì§€ì¶œ ëŒ€ë¹„ ì¬ë¬´ ì‹œë®¬ë ˆì´í„°</h1>
      <p class="muted" style="font-size:15px; margin-bottom:22px;">í˜„ì¬ ìì‚°ê³¼ ë¯¸ë˜ ì˜ˆìƒ ìˆ˜ì…/ì§€ì¶œì„ í•©ì³, íŠ¹ì • ì‹œì  ëª©ëˆ ì§€ì¶œì„ ê°ë‹¹í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
      <button class="btn-primary" id="btn-login">Google ë¡œê·¸ì¸ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
    </div>
  </section>

  <main id="main-app" class="wrap hidden">
    <div class="top">
      <div>
        <div class="title-row">
          <h1 id="title-text">ì¬ë¬´ ì‹œë®¬ë ˆì´í„°</h1>
        </div>
        <p class="muted" style="margin: 4px 0 0;">í•µì‹¬ ê¸°ëŠ¥: ë¯¸ë˜ í° ì§€ì¶œ ì‹œì ì˜ ìê¸ˆ ë¶€ì¡± ì—¬ë¶€ë¥¼ ì›”ë³„ í˜„ê¸ˆíë¦„ ê¸°ë°˜ìœ¼ë¡œ ì§„ë‹¨</p>
      </div>
      <button class="btn-ghost" id="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <section class="kpis">
      <div class="card kpi"><p>ì´ ìˆœìì‚°</p><h3 id="board-networth">0ì›</h3></div>
      <div class="card kpi"><p>í˜„ì¬ ê°€ìš©ìì‚°</p><h3 id="board-available">0ì›</h3></div>
    </section>

    <section class="actions">
      <button style="background: var(--primary); color: #fff; border: none; font-size: 15px;" onclick="openModal('modal-asset')">ğŸ’° í˜„ì¬ ìì‚°/ë¶€ì±„ ì…ë ¥</button>
      <button style="background: var(--primary); color: #fff; border: none; font-size: 15px;" onclick="openModal('modal-monthly')">ğŸ“… ë¯¸ë˜ ì›” ìˆ˜ì…/ì§€ì¶œ ì…ë ¥</button>
    </section>

    <section class="layout">
      <div class="section card">
        <div class="sub-head">
          <h2>ë¯¸ë˜ ì‹œì  ìì‚° ì˜ˆì¸¡</h2>
        </div>

        <div class="input-row">
          <input type="date" id="pred-date" style="max-width:210px;" />
          <button class="btn-primary" onclick="window.calculatePrediction()">í•´ë‹¹ì¼ ì˜ˆì¸¡</button>
          </div>
        <div class="input-row">
          <input disabled value="ì˜ˆì¸¡ ê°€ìš©ìì‚°" style="max-width:130px; color:var(--sub);" />
          <input id="pred-avail" disabled />
          <input disabled value="ì˜ˆì¸¡ ìˆœìì‚°" style="max-width:110px; color:var(--sub);" />
          <input id="pred-net" disabled />
        </div>

        <div class="sub-head" style="margin-top:12px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <h2 style="margin:0; font-size:16px;">ìì‚° ë³€í™” ê·¸ë˜í”„</h2>
            <button class="btn-ghost" style="padding:4px 8px; font-size:12px;" onclick="openModal('modal-forecast')">ì›”ë³„ ìƒì„¸ ë³´ê¸° ğŸ“Š</button>
          </div>
          <label class="muted">í‘œì‹œ ì—°ë„
            <input type="number" id="chart-year" min="2025" value="2035" onchange="window.drawChart()" style="width:90px; margin-left:6px;" />
          </label>
        </div>
        <div style="position:relative;height:230px;"><canvas id="predictChart"></canvas></div>
      </div>

      <div class="section card" style="border-color:#cad8ff;">
        <h2>ë¯¸ë˜ ëª©ëˆ ì§€ì¶œ ì¼ì • & ì§„ë‹¨</h2>
        <div class="input-row">
          <input type="date" id="sch-date" />
          <input type="text" id="sch-memo" placeholder="ì˜ˆ: ì „ì„¸ ê°±ì‹ , ì°¨ëŸ‰ ì”ê¸ˆ" style="flex:1.6;" />
        </div>
        <div class="input-row">
          <input type="number" id="sch-amount" placeholder="í•„ìš” ê¸ˆì•¡(ì›)" />
          <button class="btn-primary" onclick="saveData('schedule')">ì¼ì • ë“±ë¡</button>
        </div>

        <h3 style="font-size:15px; margin:14px 0 6px;">ì¦‰ì‹œ ì‹œë‚˜ë¦¬ì˜¤ ì ê²€ (ì €ì¥ ì—†ì´ í…ŒìŠ¤íŠ¸)</h3>
        <div class="input-row" style="margin-bottom:3px;">
          <input type="date" id="quick-date" />
          <input type="number" id="quick-amount" placeholder="í…ŒìŠ¤íŠ¸ ê¸ˆì•¡(ì›)" />
          <button class="btn-primary" onclick="window.runQuickCheck()">ì‹œë®¬ë ˆì´ì…˜</button>
        </div>
        <p id="quick-result" class="muted" style="margin-top:0;">ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ë¶€ì¡±/ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>

        <p class="muted" style="margin-top:8px;">ë“±ë¡ëœ ì¼ì •ì€ í•´ë‹¹ ë‚ ì§œ "ì§ì „" ì”ì•¡ ê¸°ì¤€ìœ¼ë¡œ ì¶©ë‹¹ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.</p>
        <div id="simulator-list" class="sim-list"></div>
      </div>
    </section>
  </main>

  <div id="modal-asset" class="modal-overlay">
    <section class="modal">
      <div class="modal-head">
        <h3>ğŸ’° í˜„ì¬ ìì‚° / ë¶€ì±„ ê´€ë¦¬</h3>
        <button class="btn-close" onclick="closeModal('modal-asset')">Ã—</button>
      </div>
      <div class="input-row">
        <input type="text" id="ast-cat" placeholder="ë¶„ë¥˜ (ì˜ˆ: ë¹„ìƒê¸ˆ, ì˜ˆê¸ˆ, ëŒ€ì¶œ)" list="cat-hints" />
        <datalist id="cat-hints"><option value="í˜„ê¸ˆì„± ìì‚°" /><option value="íˆ¬ì ìì‚°" /><option value="ë¶€ë™ì‚°" /><option value="ëŒ€ì¶œ" /></datalist>
        <select id="ast-behavior">
          <option value="avail">ğŸŸ¢ ê°€ìš©</option>
          <option value="tied">ğŸ  ë¬¶ì¸ ìì‚°</option>
          <option value="loan">ğŸ”» ë¶€ì±„</option>
          <option value="mental_loan">â˜ï¸ ì‹¬ì  ë¶€ì±„</option>
        </select>
        <input type="text" id="ast-memo" placeholder="ë©”ëª¨" />
      </div>
      <div class="input-row">
        <input type="number" id="ast-amount" placeholder="í˜„ì¬ ê¸ˆì•¡(ì›)" />
        <button class="btn-primary" id="btn-ast-save" onclick="saveData('asset')">ë“±ë¡</button>
      </div>
      <table>
        <thead><tr><th>ë¶„ë¥˜</th><th>ì†ì„±</th><th>ë©”ëª¨</th><th class="td-right">ê¸ˆì•¡</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="asset-list"></tbody>
      </table>
    </section>
  </div>

  <div id="modal-monthly" class="modal-overlay">
    <section class="modal" style="width: min(1000px, 100%);">
      <div class="modal-head">
        <h3>ğŸ“… ë¯¸ë˜ ì›” ìˆ˜ì… / ì§€ì¶œ ê´€ë¦¬</h3>
        <button class="btn-close" onclick="closeModal('modal-monthly')">Ã—</button>
      </div>
      <p class="muted">ì˜ˆ: ê¸‰ì—¬, ì„ëŒ€ìˆ˜ìµ, ë³´í—˜ë£Œ, í• ë¶€, êµìœ¡ë¹„. ì‹œì‘ì›”~ì¢…ë£Œì›” ë²”ìœ„ ë‚´ì—ì„œ ë§¤ì›” ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
      
      <div style="background: var(--bg); padding: 12px; border-radius: 12px; margin-bottom: 16px;">
        <div class="input-row">
          <select id="mo-type" style="max-width:120px;"><option value="income">ìˆ˜ì…</option><option value="expense">ì§€ì¶œ</option></select>
          <input type="text" id="mo-memo" placeholder="í•­ëª©ëª…" />
          <input type="number" id="mo-amount" placeholder="ì›” ê¸ˆì•¡(ì›)" />
        </div>
        <div class="input-row">
          <input type="text" id="mo-desc" placeholder="ìƒì„¸ ë©”ëª¨ ì‘ì„± (ì„ íƒ)" style="flex:1;" />
        </div>
        <div class="input-row" style="margin-bottom:0;">
          <input type="month" id="mo-start" />
          <input type="month" id="mo-end" placeholder="ì¢…ë£Œì›”(ì„ íƒ)" />
          <button class="btn-primary" id="btn-mo-save" onclick="saveData('monthly')">í•­ëª© ì¶”ê°€</button>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start;">
        <div style="background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0;">
          <h4 style="margin: 0 0 10px; color: #09a66d;">ğŸŸ¢ ìˆ˜ì… ëª©ë¡</h4>
          <div class="table-scroll" style="max-height: 280px;">
            <table>
              <thead><tr><th>í•­ëª©(ê¸°ê°„)</th><th class="td-right">ê¸ˆì•¡</th><th style="width:80px; text-align:center;">ê´€ë¦¬</th></tr></thead>
              <tbody id="income-list"></tbody>
            </table>
          </div>
        </div>
        
        <div style="background: #fff5f5; padding: 12px; border-radius: 12px; border: 1px solid #fed7d7;">
          <h4 style="margin: 0 0 10px; color: #e53e3e;">ğŸ”´ ì§€ì¶œ ëª©ë¡</h4>
          <div class="table-scroll" style="max-height: 280px;">
            <table>
              <thead><tr><th>í•­ëª©(ê¸°ê°„)</th><th class="td-right">ê¸ˆì•¡</th><th style="width:80px; text-align:center;">ê´€ë¦¬</th></tr></thead>
              <tbody id="expense-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="modal-forecast" class="modal-overlay">
    <section class="modal">
      <div class="modal-head">
        <h3>ğŸ“Š ì›”ë³„ ì‹œë®¬ë ˆì´ì…˜ ìƒì„¸</h3>
        <button class="btn-close" onclick="closeModal('modal-forecast')">Ã—</button>
      </div>
      <div class="table-scroll" style="max-height: 60vh;">
        <table>
          <thead><tr><th>ì›”</th><th class="td-right">ì›” ìˆœí˜„ê¸ˆíë¦„</th><th class="td-right">ëˆ„ì  ê°€ìš©ìì‚°</th><th class="td-right">ëˆ„ì  ìˆœìì‚°</th></tr></thead>
          <tbody id="forecast-table-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="modal-memo" class="modal-overlay" style="z-index: 100;">
    <section class="modal" style="width: min(400px, 100%);">
      <div class="modal-head">
        <h3>ğŸ“ ìƒì„¸ ë©”ëª¨</h3>
        <button class="btn-close" onclick="closeModal('modal-memo')">Ã—</button>
      </div>
      <p id="memo-content" style="white-space: pre-wrap; color: var(--text); font-size: 14px; margin-top: 10px;"></p>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDrvsZaC1w8wYGr4jLQSK9exHU36kpilYY",
      authDomain: "my-dashboard-e4645.firebaseapp.com",
      projectId: "my-dashboard-e4645",
      storageBucket: "my-dashboard-e4645.firebasestorage.app",
      messagingSenderId: "991484655216",
      appId: "1:991484655216:web:3c8b1799a5a3c742d926b5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const KRW = new Intl.NumberFormat('ko-KR');
    const won = (num) => `${KRW.format(Math.round(num || 0))}ì›`;
    const parseDate = (str) => new Date(`${str}T00:00:00`);
    const monthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    const monthStart = (date) => new Date(date.getFullYear(), date.getMonth(), 1);
    const monthEnd = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0);

    let gAvailable = 0;
    let gNetWorth = 0;
    let gMonthlyItems = [];
    let gSchedules = [];
    let gAssets = []; // ìì‚°/ë¶€ì±„ ê´€ë¦¬ë¥¼ ìœ„í•œ ë°°ì—´ ì¶”ê°€
    let editingMonthlyId = null;
    let editingAssetId = null; // ìì‚° ìˆ˜ì • ìƒíƒœ ê´€ë¦¬

    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    window.showMemo = (desc) => {
      document.getElementById('memo-content').innerText = desc || 'ì‘ì„±ëœ ìƒì„¸ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.';
      openModal('modal-memo');
    };

    function getMonthlyFlow(month) {
      return gMonthlyItems.reduce((sum, item) => {
        if (month < item.start || month > item.end) return sum;
        return sum + (item.type === 'income' ? item.amount : -item.amount);
      }, 0);
    }

    function sumSchedulesInRange(startDate, endDate, excludeId = null) {
      return gSchedules.reduce((sum, s) => {
        if (excludeId && s.id === excludeId) return sum;
        const d = parseDate(s.date);
        if (d >= startDate && d <= endDate) return sum + (s.amount || 0);
        return sum;
      }, 0);
    }

    function simulateTo(targetDateStr, options = {}) {
      const targetDate = parseDate(targetDateStr);
      const includeTargetEvents = options.includeTargetEvents !== false;
      const excludeScheduleId = options.excludeScheduleId || null;

      let cash = gAvailable;
      let net = gNetWorth;
      const today = new Date();
      let cursor = monthStart(today);

      while (cursor <= targetDate) {
        const mk = monthKey(cursor);
        const flow = getMonthlyFlow(mk);
        cash += flow;
        net += flow;

        const monthLast = monthEnd(cursor);
        const rangeEnd = monthLast < targetDate ? monthLast : targetDate;
        let eventsOut = sumSchedulesInRange(cursor, rangeEnd, excludeScheduleId);

        if (!includeTargetEvents) {
          const exactTargetOut = gSchedules.reduce((sum, s) => {
            const d = parseDate(s.date);
            if (excludeScheduleId && s.id === excludeScheduleId) return sum;
            if (d.getTime() === targetDate.getTime()) return sum + (s.amount || 0);
            return sum;
          }, 0);
          eventsOut -= exactTargetOut;
        }

        cash -= eventsOut;
        net -= eventsOut;
        cursor.setMonth(cursor.getMonth() + 1);
      }
      return { avail: cash, net };
    }

    function buildRows(untilYear = Number(document.getElementById('chart-year').value || new Date().getFullYear() + 8)) {
      const rows = [];
      const now = new Date();
      let cursor = monthStart(now);
      const end = new Date(untilYear, 11, 31);
      let cash = gAvailable;
      let net = gNetWorth;

      while (cursor <= end) {
        const mk = monthKey(cursor);
        const flow = getMonthlyFlow(mk);
        const out = sumSchedulesInRange(cursor, monthEnd(cursor));
        const netFlow = flow - out;
        cash += netFlow;
        net += netFlow;
        rows.push({ month: mk, flow: netFlow, cash, net });
        cursor.setMonth(cursor.getMonth() + 1);
      }
      return rows;
    }

    window.calculatePrediction = () => {
      const target = document.getElementById('pred-date').value;
      if (!target) return;
      const result = simulateTo(target);
      document.getElementById('pred-avail').value = won(result.avail);
      document.getElementById('pred-net').value = won(result.net);
    };

    window.runQuickCheck = () => {
      const d = document.getElementById('quick-date').value;
      const amount = Number(document.getElementById('quick-amount').value || 0);
      if (!d || !amount) return;
      const before = simulateTo(d, { includeTargetEvents: false }).avail;
      const remain = before - amount;
      const el = document.getElementById('quick-result');
      if (remain >= 0) {
        el.innerHTML = `<span class="pill ok">ê°€ëŠ¥</span> í•´ë‹¹ì¼ ì§ì „ ì”ì•¡ ${won(before)} Â· ì§€ì¶œ í›„ ${won(remain)} ë‚¨ìŒ`;
      } else {
        el.innerHTML = `<span class="pill bad">ë¶€ì¡±</span> í•´ë‹¹ì¼ ì§ì „ ì”ì•¡ ${won(before)} Â· ${won(-remain)} ë¶€ì¡±`;
      }
    };

    window.drawChart = () => {
      const rows = buildRows();
      const labels = rows.map(r => r.month.slice(2));

      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(document.getElementById('predictChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'ê°€ìš© ìì‚°', data: rows.map(r => r.cash), borderColor: '#09a66d', backgroundColor: 'rgba(9,166,109,.13)', fill: true, tension: .3, pointRadius: 0 },
            { label: 'ìˆœìì‚°', data: rows.map(r => r.net), borderColor: '#2f6bff', backgroundColor: 'rgba(47,107,255,.12)', fill: true, tension: .3, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: { y: { ticks: { callback: (v) => `${Number((v / 100000000).toFixed(1))}ì–µ` } } }
        }
      });

      document.getElementById('forecast-table-body').innerHTML = rows.slice(0, 120).map((r) => `
        <tr>
          <td>${r.month}</td>
          <td class="td-right" style="color:${r.flow >= 0 ? '#09a66d' : '#ef4f5f'}">${won(r.flow)}</td>
          <td class="td-right">${won(r.cash)}</td>
          <td class="td-right">${won(r.net)}</td>
        </tr>
      `).join('');
    };

    function renderSchedules() {
      gSchedules.sort((a, b) => parseDate(a.date) - parseDate(b.date));
      const html = gSchedules.map((s) => {
        const before = simulateTo(s.date, { includeTargetEvents: false, excludeScheduleId: s.id }).avail;
        const remain = before - s.amount;
        const badge = remain >= 0
          ? `<span class="pill ok">ì¶©ë‹¹ ê°€ëŠ¥ Â· ì§€ì¶œ í›„ ${won(remain)} ë‚¨ìŒ</span>`
          : `<span class="pill bad">${won(-remain)} ë¶€ì¡±</span>`;

        return `
          <div class="sim-card">
            <div class="sim-top">
              <div><strong>ğŸ“Œ ${s.date}</strong><div class="muted">${s.memo}</div></div>
              <div style="text-align:right;">í•„ìš” ${won(s.amount)} <button class="btn-mini btn-del" onclick="deleteItem('${s.id}')">ì‚­ì œ</button></div>
            </div>
            <div style="margin-top:8px;">${badge}</div>
          </div>
        `;
      }).join('');

      document.getElementById('simulator-list').innerHTML = html || '<p class="muted">ë“±ë¡ëœ ëª©ëˆ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    window.editTitle = async () => {
      const title = prompt('ëŒ€ì‹œë³´ë“œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', document.getElementById('title-text').innerText);
      if (!title) return;
      await setDoc(doc(db, 'uiwang_v10_settings', 'config'), { title }, { merge: true });
    };

    // ì›”ê°„ ìˆ˜ì…/ì§€ì¶œ í•­ëª© ìˆ˜ì •ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    window.editMonthly = (id) => {
      const item = gMonthlyItems.find(v => v.id === id);
      if (!item) return;
      document.getElementById('mo-type').value = item.type;
      document.getElementById('mo-memo').value = item.memo;
      document.getElementById('mo-amount').value = item.amount;
      document.getElementById('mo-desc').value = item.desc || '';
      document.getElementById('mo-start').value = item.start;
      document.getElementById('mo-end').value = item.end === '9999-12' ? '' : item.end;
      editingMonthlyId = id;
      const btn = document.getElementById('btn-mo-save');
      btn.innerText = 'ìˆ˜ì • ì €ì¥';
      btn.style.background = '#3b82f6';
    };

    // ìì‚° í•­ëª© ìˆ˜ì •ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ì¶”ê°€
    window.editAsset = (id) => {
      const item = gAssets.find(v => v.id === id);
      if (!item) return;
      document.getElementById('ast-cat').value = item.cat;
      document.getElementById('ast-behavior').value = item.behavior;
      document.getElementById('ast-memo').value = item.memo || '';
      document.getElementById('ast-amount').value = item.amount;
      editingAssetId = id;
      const btn = document.getElementById('btn-ast-save');
      btn.innerText = 'ìˆ˜ì • ì €ì¥';
      btn.style.background = '#3b82f6';
    };

    window.saveData = async (docType) => {
      const data = { docType, createdAt: Date.now() };

      if (docType === 'monthly') {
        data.type = document.getElementById('mo-type').value;
        data.memo = document.getElementById('mo-memo').value.trim();
        data.desc = document.getElementById('mo-desc').value.trim();
        data.amount = Number(document.getElementById('mo-amount').value);
        data.start = document.getElementById('mo-start').value;
        data.end = document.getElementById('mo-end').value || '9999-12';
        if (!data.memo || !data.amount || !data.start) return alert('í•­ëª©ëª…, ì›” ê¸ˆì•¡, ì‹œì‘ì›”ì„ ì…ë ¥í•˜ì„¸ìš”.');

        if (editingMonthlyId) {
          await setDoc(doc(db, 'uiwang_v10', editingMonthlyId), data);
          editingMonthlyId = null;
          const btn = document.getElementById('btn-mo-save');
          btn.innerText = 'í•­ëª© ì¶”ê°€';
          btn.style.background = 'var(--primary)';
        } else {
          await addDoc(collection(db, 'uiwang_v10'), data);
        }

        document.getElementById('mo-memo').value = '';
        document.getElementById('mo-desc').value = '';
        document.getElementById('mo-amount').value = '';
        return;
      }

      // ìì‚° ìˆ˜ì •/ì €ì¥ ë¶„ë¦¬ ì²˜ë¦¬
      if (docType === 'asset') {
        data.behavior = document.getElementById('ast-behavior').value;
        data.cat = document.getElementById('ast-cat').value.trim() || 'ë¯¸ë¶„ë¥˜';
        data.memo = document.getElementById('ast-memo').value.trim();
        data.amount = Number(document.getElementById('ast-amount').value);
        if (!data.amount) return alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');

        if (editingAssetId) {
          await setDoc(doc(db, 'uiwang_v10', editingAssetId), data);
          editingAssetId = null;
          const btn = document.getElementById('btn-ast-save');
          btn.innerText = 'ë“±ë¡';
          btn.style.background = 'var(--primary)';
        } else {
          await addDoc(collection(db, 'uiwang_v10'), data);
        }

        document.getElementById('ast-cat').value = '';
        document.getElementById('ast-memo').value = '';
        document.getElementById('ast-amount').value = '';
        return;
      }

      if (docType === 'schedule') {
        data.date = document.getElementById('sch-date').value;
        data.memo = document.getElementById('sch-memo').value.trim();
        data.amount = Number(document.getElementById('sch-amount').value);
        if (!data.date || !data.memo || !data.amount) return alert('ë‚ ì§œ, ì¼ì •ëª…, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        await addDoc(collection(db, 'uiwang_v10'), data);
        document.getElementById('sch-memo').value = '';
        document.getElementById('sch-amount').value = '';
      }
    };

    window.deleteItem = async (id) => {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await deleteDoc(doc(db, 'uiwang_v10', id));
    };

    function loadData() {
      onSnapshot(query(collection(db, 'uiwang_v10')), (snapshot) => {
        gMonthlyItems = [];
        gSchedules = [];
        gAssets = [];
        let avail = 0, tied = 0, loan = 0;
        
        let assetRows = '';
        let incomeRows = '';
        let expenseRows = '';

        snapshot.forEach((snap) => {
          const d = snap.data();
          d.id = snap.id;

          if (d.docType === 'monthly') {
            gMonthlyItems.push(d);
            const isInc = d.type === 'income';
            const escapedDesc = (d.desc || '').replace(/'/g, "\\'").replace(/\n/g, '\\n');
            const endTxt = d.end === '9999-12' ? 'ê³„ì†' : d.end;
            
            // ìˆ˜ì…/ì§€ì¶œ ê³µí†µ row ìƒì„±
            const rowHtml = `
              <tr onclick="window.showMemo('${escapedDesc}')" style="cursor:pointer;" title="í´ë¦­í•˜ì—¬ ë©”ëª¨ ë³´ê¸°">
                <td style="text-decoration:underline;">
                  ${d.memo}<br>
                  <span style="font-size:11px;color:var(--sub);text-decoration:none;">${d.start} ~ ${endTxt}</span>
                </td>
                <td class="td-right" style="font-weight:700; color:${isInc ? '#09a66d' : '#e53e3e'}">${won(d.amount)}</td>
                <td onclick="event.stopPropagation()" style="text-align:center; white-space:nowrap;">
                  <button class="btn-mini btn-edit" onclick="window.editMonthly('${d.id}')">ìˆ˜ì •</button>
                  <button class="btn-mini btn-del" onclick="window.deleteItem('${d.id}')">ì‚­ì œ</button>
                </td>
              </tr>
            `;

            if (isInc) incomeRows += rowHtml;
            else expenseRows += rowHtml;
          }

          if (d.docType === 'asset') {
            gAssets.push(d);
            let attr = 'ğŸŸ¢ ê°€ìš©';
            let sign = '';
            if (d.behavior === 'avail') avail += d.amount;
            if (d.behavior === 'tied') { tied += d.amount; attr = 'ğŸ  ë¬¶ì„'; }
            if (d.behavior === 'loan') { loan += d.amount; attr = 'ğŸ”» ë¶€ì±„'; sign = '-'; }
            if (d.behavior === 'mental_loan') attr = 'â˜ï¸ ì‹¬ì  ë¶€ì±„';

            assetRows += `
              <tr>
                <td>${d.cat}</td>
                <td>${attr}</td>
                <td>${d.memo || '-'}</td>
                <td class="td-right">${sign}${won(d.amount)}</td>
                <td style="white-space:nowrap;">
                  <button class="btn-mini btn-edit" onclick="window.editAsset('${d.id}')">ìˆ˜ì •</button>
                  <button class="btn-mini btn-del" onclick="deleteItem('${d.id}')">ì‚­ì œ</button>
                </td>
              </tr>
            `;
          }

          if (d.docType === 'schedule') gSchedules.push(d);
        });

        gAvailable = avail;
        gNetWorth = avail + tied - loan;

        document.getElementById('board-networth').innerText = won(gNetWorth);
        document.getElementById('board-available').innerText = won(gAvailable);
        
        // ë°ì´í„°ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ë¹ˆ ê³µê°„ ì±„ìš°ê¸°
        document.getElementById('income-list').innerHTML = incomeRows || '<tr><td colspan="3" style="text-align:center; color:var(--sub);">ìˆ˜ì… ì—†ìŒ</td></tr>';
        document.getElementById('expense-list').innerHTML = expenseRows || '<tr><td colspan="3" style="text-align:center; color:var(--sub);">ì§€ì¶œ ì—†ìŒ</td></tr>';
        document.getElementById('asset-list').innerHTML = assetRows || '<tr><td colspan="5" style="text-align:center; color:var(--sub);">ë°ì´í„° ì—†ìŒ</td></tr>';

        renderSchedules();
        window.calculatePrediction();
        window.runQuickCheck();
        window.drawChart();
      });
    }

    document.getElementById('btn-login').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    const ALLOWED_EMAILS = ["jjhwang1016@gmail.com", "mjjjj10166@gmail.com"];

    onAuthStateChanged(auth, (user) => {
      if (user && !ALLOWED_EMAILS.includes(user.email)) {
        alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤. ê³½ / í™© / ì¾…ì¾…ì´ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ˜Š");
        signOut(auth);
        return;
      }

      document.getElementById('login-screen').classList.toggle('hidden', !!user);
      document.getElementById('main-app').classList.toggle('hidden', !user);
      if (!user) return;

      const now = new Date();
      const yyyyMm = monthKey(now);
      document.getElementById('mo-start').value = yyyyMm;

      const oneYearLater = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate());
      const iso = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      document.getElementById('pred-date').value = iso(oneYearLater);
      document.getElementById('sch-date').value = iso(now);
      document.getElementById('quick-date').value = iso(oneYearLater);

      onSnapshot(doc(db, 'uiwang_v10_settings', 'config'), (snap) => {
        if (snap.exists() && snap.data().title) document.getElementById('title-text').innerText = snap.data().title;
      });

      loadData();
    });
  </script>
</body>
</html>